<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0">
  <meta http-equiv="Refresh" content="0;url=yjzs://"/>
  <title>测试打开yjzs app</title>
  <style>
    *{margin:0; padding:0;}
    .yjzs-container {
      background: url(./background.png) no-repeat;
      background-position: center;
      background-size: cover;
      height: 100vh;
      text-align: center;
    }
    .yjzs-container__logo {
      width: 105px;
      height: 105px;
      margin-top: 148px;
    }
    .yjzs-container__title {
      font-family: PingFangSC-Medium;
      font-size: 22px;
      color: #384A63;
      font-weight: 500;
      margin-top: 40px;
    }
    .yjzs-container__content {
      width: 225px;
      border-top: 1px solid #d8d8d8;
      margin: 32px auto auto;
      text-align: center;
      /* display: flex;
      justify-content: center; */
    }
    .content__text {
      font-size: 14px;
      color: #969fad;
      font-weight: 400;
      margin-top: 28px;
    }
    .content__btn {
      position: fixed;
      bottom: 134px;
      left: 50%;
      transform: translateX(-50%);
      display: block;
      width: 184px;
      height: 48px;
      line-height: 48px;
      text-align: center;
      background: #436BFF;
      box-shadow: 0 3px 8px 1px rgba(85,212,255,0.15);
      border-radius: 24px;
      font-family: PingFangSC-Regular;
      font-size: 16px;
      color: #FFFFFF;
      font-weight: 400;
      text-decoration: none;
    }
    #open {
      background: #fff;
      color: #384A63;
      border: 1px solid #d8d8d8;
      box-shadow: none;
      bottom: 66px;
    }
  </style>
</head>
<body>
  <div class="yjzs-container">
    <img class="yjzs-container__logo" src="./logo.png" />
    <div class="yjzs-container__title">云镜助手</div>
    <div class="yjzs-container__content">
      <div class="content__text">
        <div class="content__text-version">未知（版本）- 未知 MB</div>
        <div class="content__text-time">更新于：未知</div>
      </div>
      <div id="download" class="content__btn">下载安装</div>
      <div id="open" class="content__btn">立即打开</div>
    </div>
  </div>
  <script>
    window.onload = function () {
      var container = document.querySelector('.yjzs-container')
      container.style.height = window.innerHeight + 'px'

      var SCHEMAE_PATH = 'yjzs://'
      var DOWN_LOAD_PATH = 'https://yc.cloudglab.com/yjzs/apk-download/yjzs_release.apk'

      // 获取下载页面展示信息
      function getAppDetail() {
        var xhr = new XMLHttpRequest()
        xhr.timeout = 5000
        xhr.responseType = 'json'
        
        xhr.open('POST', 'https://yc.cloudglab.com/yuncai_app/management/version/checkUpdate');
        xhr.setRequestHeader("Content-Type"
        , "application/json;charset=UTF-8");
        xhr.send(JSON.stringify({
          name: 'yc3.0',
          version: '1.7.0'
        }))
        xhr.onload = function () {
          if((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304){
            const res = xhr.response.data
            var versionText = document.querySelector('.content__text-version')
            versionText.innerHTML = (res.version  || '未知') + '（版本）' + '-' + (res.pkgSize || '未知')
            var timeText = document.querySelector('.content__text-time')
            timeText.innerHTML = '更新于：' + (res.updateTime || '未知')

            res.pkgScheme && (SCHEMAE_PATH = res.pkgScheme)
            res.pkgUrl && (DOWN_LOAD_PATH = res.pkgUrl)
          }
        }
      }
      getAppDetail()
      
      // 对点击事件节流处理
      function throttle(fun, time) {
        var timer,last
        return function() {
          var that = this
          var args = arguments
          var now = Date.now()
          if(last && time > now - last) {
            clearTimeout(timer)
            timer = setTimeout(function() {
              fun.apply(that, args)
              last = now
            }, time);
          } else {
            fun.apply(that, args)
            last = now
          }
        }
      }

      function openUrl(url) {
        // 创建iframe标签打开（不会跳转到错误页面）
        var iframe = document.createElement('iframe')
        iframe.frameBorder = '0'
        iframe.style.cssText = 'display:none;border:0;width:0;height:0;'
        document.body.appendChild(iframe)
        iframe.src = url
      }

      function appNotExist() {
        // 2.5s秒后未打开则执行下载
        var timer = setTimeout(() => {
          downloadApp();
        }, 2500);

        // 页面隐藏，那么代表已经调起了app，就清除下载的定时器
        var visibilitychange = function() {
          var tag = document.hidden || document.webkitHidden;
          tag && clearTimeout(timer);
        };

        document.addEventListener("visibilitychange", visibilitychange, false);
        document.addEventListener("webkitvisibilitychange", visibilitychange, false);
        window.addEventListener(
          "pagehide",
          function() {
            alert('pagehide');
            clearTimeout(timer);
          },
          false
        );
      }

      function openApp() {
        openUrl(SCHEMAE_PATH)
        appNotExist()
      }

      function downloadApp() {
        // alert('download done');
        openUrl(DOWN_LOAD_PATH)
      }

      var openBtn = document.getElementById('open')
      openBtn && openBtn.addEventListener('click',throttle(openApp, 1000))

      var downloadBtn = document.getElementById('download')
      downloadBtn && downloadBtn.addEventListener('click',throttle(downloadApp, 1000))

      
      // 微信中打开展示遮罩
      function is_weixin() {
          var ua = navigator.userAgent.toLowerCase();
          if (ua.match(/MicroMessenger/i) == "micromessenger") {
              return true;
          } else {
              return false;
          }
      }
      
      function loadHtml(){
        var div = document.createElement('div');
        div.id = 'weixin-tip';
        div.innerHTML = '<p><img class="weixin-tip-img" src="live_weixin.png" alt="微信打开"/></p>';
        document.body.appendChild(div);
      }
      
      function loadStyleText(cssText) {
        var style = document.createElement('style');
        style.rel = 'stylesheet';
        style.type = 'text/css';
        try {
            style.appendChild(document.createTextNode(cssText));
        } catch (e) {
            style.styleSheet.cssText = cssText; //ie9以下
        }
          var head=document.getElementsByTagName("head")[0]; //head标签之间加上style样式
          head.appendChild(style); 
        }
        var cssText = "#weixin-tip{position: fixed; left:0; top:0; background: rgba(0,0,0,0.8); filter:alpha(opacity=80); width: 100%; height:100%; z-index: 100;} #weixin-tip p{text-align: center; margin-top: 10%; padding:0 5%;} .weixin-tip-img{max-width: 100%; height: auto;}";
      if(is_weixin()){
        loadHtml();
        loadStyleText(cssText);
      }
    }
    
  </script>
</body>
</html>